<mat-toolbar color="primary">
  <div class="title" *ngIf="bucket$ | async; let bucket">
    <h1>
      <mat-icon>{{ bucket.icon }}</mat-icon>
      <span>{{ bucket.title }}</span>
    </h1>
    <h6>{{ bucket.description }}</h6>
  </div>
  <span class="space-between"></span>
  <button
    *ngIf="histories$ | async; let histories"
    mat-icon-button
    [matMenuTriggerFor]="historyMenu"
  >
    <mat-icon> restore </mat-icon>
    <mat-menu #historyMenu="matMenu" class="history-tree mat-elevation-z25" xPosition="before">
      <button
        mat-icon-button
        mat-raised-button
        [disabled]="!now"
        color="primary"
        class="mat-elevation-z0"
        (click)="data = now; $event.stopPropagation()"
        matTooltip="Now"
        matTooltipPosition="before"
      >
        N
      </button>
      <button
        *ngFor="let history of histories; let index = index"
        mat-icon-button
        mat-raised-button
        color="accent"
        class="mat-elevation-z0"
        (click)="revert(history._id); $event.stopPropagation()"
        [matTooltip]="history.date | date: 'MMM d y, h:mm:ss a'"
        matTooltipPosition="before"
        [matBadge]="history.changes"
        matBadgeColor="warn"
        matBadgeSize="small"
      >
        {{ index + 1 }}
      </button>
    </mat-menu>
  </button>
</mat-toolbar>

<mat-card *ngIf="bucket$ | async; let bucket" class="mat-elevation-z25">
  <mat-card-content>
    <form class="block-form" #form="ngForm">
      <div *ngFor="let layout of layouts" [class]="layout">
        <ng-container *ngFor="let propertyKv of bucket['positioned'][layout]">
          <div
            *ngIf="propertyKv.value.options.translate && data[propertyKv.key]"
            [inputPlacer]="propertyKv.value"
            class="property-translate"
            [disabled]="propertyKv.value.readOnly || !language.selected"
            [required]="bucket.required && bucket.required.indexOf(propertyKv.key) > -1"
            [name]="propertyKv.key"
            [(ngModel)]="data[propertyKv.key][language.selected]"
          >
            <property-language #language slot="after"></property-language>
          </div>
          <div
            *ngIf="!propertyKv.value.options.translate"
            [inputPlacer]="propertyKv.value"
            [disabled]="propertyKv.value.readOnly"
            [required]="bucket.required && bucket.required.indexOf(propertyKv.key) > -1"
            [name]="propertyKv.key"
            [(ngModel)]="data[propertyKv.key]"
          ></div>
        </ng-container>
      </div>
    </form>
  </mat-card-content>

  <mat-card-actions class="save">
    <form class="schedule" #scheduleForm="ngForm" *ngIf="scheduleOn">
      <button mat-button color="warn" (click)="rejectSchedule()">
        <mat-icon>cancel</mat-icon> Reject
      </button>
      <mat-form-field>
        <input
          matInput
          [min]="minScheduleDate"
          readonly
          required
          name="scheduleDate"
          [(ngModel)]="scheduleDate"
          [owlDateTime]="dt1"
          [owlDateTimeTrigger]="dt1"
          placeholder="Date Time"
        />
        <owl-date-time #dt1></owl-date-time>
      </mat-form-field>
    </form>

    <button mat-button (click)="scheduleOnTrue()" *ngIf="!scheduleOn">Set Publish Date</button>

    <button
      canInteract="bucket:data:update"
      *ngIf="!data?._id"
      [disabled]="form.invalid || (scheduleForm && scheduleForm.invalid)"
      mat-button
      (click)="saveBucketRow()"
    >
      <mat-icon>add</mat-icon> Add
    </button>
    <button
      canInteract="bucket:data:update"
      *ngIf="data?._id"
      [disabled]="form.invalid"
      mat-button
      (click)="saveBucketRow()"
    >
      <mat-icon>sync</mat-icon> Update
    </button>
  </mat-card-actions>
</mat-card>
