<ng-template #toolbar>
  <span>
    <h4>
      <mat-icon>layers</mat-icon>
      <span>{{ policy._id ? policy.name : "Add Policy" }}</span>
    </h4>
  </span>
</ng-template>

<mat-card>
  <mat-card-content>
    <form #policyForm="ngForm">
      <mat-form-field>
        <input
          matInput
          placeholder="Policy Name"
          name="policyName"
          [(ngModel)]="policy.name"
          #nameModel="ngModel"
          required
        />
        <mat-error *ngIf="nameModel?.errors?.required">
          This field is required.
        </mat-error>
      </mat-form-field>

      <mat-form-field>
        <textarea
          matInput
          placeholder="Description"
          name="policyDescription"
          [(ngModel)]="policy.description"
          #descriptionModel="ngModel"
          required
        ></textarea>
        <mat-error *ngIf="descriptionModel?.errors?.required">
          This field is required.
        </mat-error>
      </mat-form-field>

      <mat-accordion>
        <mat-expansion-panel
          class="mat-elevation-z1"
          *ngFor="let statement of policy.statements; let statementIndex = index"
        >
          <mat-expansion-panel-header>
            <mat-panel-title
              ><b>Statement:&nbsp;</b>
              {{ statement.module?.replaceAll(":", " ") | titlecase }}</mat-panel-title
            >
          </mat-expansion-panel-header>
          <div class="statement">
            <mat-form-field>
              <mat-select
                placeholder="Module"
                name="statement.module + 'name'"
                (ngModelChange)="onModuleChange(statement)"
                [(ngModel)]="statement.module"
                required
              >
                <mat-option
                  *ngFor="let service of services | keyvalue"
                  [value]="service.key"
                  [disabled]="isServiceUsed(service.key)"
                >
                  {{ service.key.replaceAll(":", " ") | titlecase }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <div class="actions">
              <div
                *ngFor="let action of services[statement.module] | keyvalue"
                class="action-card"
                (click)="toggleAction(statement.module, action.key)"
                [class.active]="isActionActive(statement.module, action.key)"
              >
                <div class="title">
                  {{ action.key.replace(statement.module + ":", "").replace(":", " ") | titlecase }}
                  <span *ngIf="acceptsResource(statement,action.key)" (click)="editResources(statement, action.key); $event.stopPropagation()">
                    <mat-icon>edit</mat-icon>
                  </span>
                </div>
                <div
                  class="resources"
                  *ngIf="acceptsResource(statement, action.key)"
                  (click)="$event.stopPropagation()"
                >
                  <ng-container
                    *ngIf="
                      getResourceSelection(getAction(statement.module, action.key)) == 'include'
                    "
                  >
                    <div class="resource">
                      <b>Include:</b>
                      <span *ngFor="let include of getAction(statement.module, action.key).resource"
                        >{{ include }}
                      </span>
                    </div>
                  </ng-container>
                  <ng-container
                    *ngIf="
                      getResourceSelection(getAction(statement.module, action.key)) == 'exclude'
                    "
                  >
                    <div class="resource">
                      <b>Include:</b>
                      <span>{{ getAction(statement.module, action.key).resource.include }}</span>
                    </div>
                    <div class="resource">
                      <b>Exclude:</b>
                      <span
                        *ngFor="
                          let exclude of getAction(statement.module, action.key).resource.exclude
                        "
                        >{{ exclude }}
                      </span>
                    </div>
                  </ng-container>
                </div>
              </div>
            </div>

            <mat-action-row>
              <button mat-button color="warn" (click)="removeStatement(statementIndex)">
                Remove Statement
              </button>
            </mat-action-row>
          </div>
        </mat-expansion-panel>
      </mat-accordion>
      <button class="add-statement-button" mat-button (click)="addStatement()">
        Add Statement <mat-icon>add</mat-icon>
      </button>
    </form>
  </mat-card-content>
  <mat-card-actions>
    <button
      class="save-button"
      mat-button
      [disabled]="policyForm.invalid || noResourceInserted()"
      [canInteract]="originalPolicy._id ? 'passport:policy:update' : 'passport:policy:create'"
      [resource]="originalPolicy._id ? originalPolicy._id : undefined"
      (click)="savePolicy()"
    >
      <mat-icon>save</mat-icon>
      <span>Save</span>
    </button>
  </mat-card-actions>
</mat-card>
